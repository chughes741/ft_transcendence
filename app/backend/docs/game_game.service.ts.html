<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: game/game.service.ts</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: game/game.service.ts</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Injectable } from "@nestjs/common";
import { WebSocketServer, WebSocketGateway } from "@nestjs/websockets";
import { Server, Socket } from "socket.io";
import { Logger } from "@nestjs/common";
import { SchedulerRegistry } from "@nestjs/schedule";
import { GameLogic } from "./game.logic";
import { GameModuleData } from "./game.data";
import * as GameTypes from "./game.types";
import * as GameDto from "./dto/game.dto";
import { v4 as uuidv4, v6 as uuidv6 } from 'uuid';
const logger = new Logger("gameService");

/**
 * GameService class
 */
@WebSocketGateway({
  cors: {
    origin: "*"
  }
})
@Injectable()
export class GameService {
  constructor(
    private schedulerRegistry: SchedulerRegistry,
    private gameLogic: GameLogic,
    private gameModuleData: GameModuleData
  ) {}

  @WebSocketServer()
  public server: Server;
  private gameState: GameTypes.GameData;

  /**
   * Creates a new game lobby with sender and invitee as players
   * @method sendGameInvite
   * @returns {}
   * @async
   * 
   * @todo add timeout for response
   * @todo pass both players data to createLobby
   */
  async sendGameInvite() {
    logger.log("joinGameInvite() called");

    // this.createLobby();
  }

  /**
   * @method joinGameQueue
   * @param {Socket} client
   * @param {JoinGameQueueDto} player
   * @returns {}
   * @async
   * @todo function
   */
  async joinGameQueue(client: Socket, player: GameDto.JoinGameQueueDto) {
    logger.log("joinGameQueue() called");

    //Create a player queue object
    const newPlayer: GameTypes.PlayerQueue = new GameTypes.PlayerQueue;

    //Populate data for player
    newPlayer.client_id = player.client_id;
    newPlayer.join_time = player.join_time;
    // queuedPlayer.client_mmr = getClientMMR();

    //Add player to queue
    this.gameModuleData.addQueue(newPlayer);

    //Emit that player has joined the queue (so a timer can be displayed client side)
    client.emit('joinedGameQueue');

    //Attempt to retrieve a pair of players
    const playerPair: GameTypes.PlayerQueue[] = this.gameModuleData.getPairQueue();
    //If successful call createLobby()
    if (playerPair) {
      this.createLobby(playerPair);
    }
  }

  /**
   * Emit event to tell client that lobby has been successfully created
   * @method createLobby
   * @param {GameTypes.PlayerQueue[]} playerPair
   * @returns {}
   * @async
   * 
   * @todo function
   */
  async createLobby(playerPair: GameTypes.PlayerQueue[]) {
    logger.log("createLobby() called");

    //Create a new lobby
    const newLobby = new GameTypes.gameLobby;

    //Populate lobby data
    newLobby.players.push(playerPair[0]);
    newLobby.players.push(playerPair[1]);
    newLobby.created_at = Date.now();
    // newLobby.lobby_id = 

    //Create a new websocket room
    this.server.socketsJoin()
    //Subscribe players to the websocket room

    //Emit lobbyCreated event to room members

  }

  /**
   * Start the game if both players are ready
   * @method gameStart
   * @returns {}
   * @async
   */
  async gameStart() {
    logger.log("gameStart() called");

    if (this.gameState.player_left_ready &amp;&amp; this.gameState.player_right_ready)
      this.startNewGame();
  }

  /**
   * Creates a new game instance
   * @method startNewGame
   * @returns {}
   * @async
   */
  async startNewGame() {
    logger.log("startNewGame() called");

    try {
      this.schedulerRegistry.getInterval("gameUpdateInterval");
    } catch {
      logger.log("Error creating gameUpdateInterval");
      this.gameLogic.createGame(this.gameState);
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="GameInviteDto.html">GameInviteDto</a></li><li><a href="GameModuleData.html">GameModuleData</a></li><li><a href="GameService.html">GameService</a></li><li><a href="GameStartEntity.html">GameStartEntity</a></li><li><a href="JoinGameEntity.html">JoinGameEntity</a></li><li><a href="JoinGameInviteDto.html">JoinGameInviteDto</a></li><li><a href="LoginGateway.html">LoginGateway</a></li><li><a href="PlayerReadyDto.html">PlayerReadyDto</a></li><li><a href="UserDto.html">UserDto</a></li><li><a href="gameLobby.html">gameLobby</a></li></ul><h3>Global</h3><ul><li><a href="global.html#GetUser">GetUser</a></li><li><a href="global.html#GetUserWs">GetUserWs</a></li><li><a href="global.html#addQueue">addQueue</a></li><li><a href="global.html#createLobby">createLobby</a></li><li><a href="global.html#gameStart">gameStart</a></li><li><a href="global.html#getPairQueue">getPairQueue</a></li><li><a href="global.html#joinGameQueue">joinGameQueue</a></li><li><a href="global.html#join_time">join_time</a></li><li><a href="global.html#removeQueue">removeQueue</a></li><li><a href="global.html#sendGameInvite">sendGameInvite</a></li><li><a href="global.html#startNewGame">startNewGame</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Mar 21 2023 14:56:18 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
